/*
================================================================================
    SALIVA cfDNA DOWNSTREAM ANALYSIS PIPELINE - CONFIGURATION
================================================================================
*/

// Default parameters
params {
    // Output options
    outdir          = 'results/downstream'
    tracedir        = "${params.outdir}/pipeline_info"
    
    // Resource defaults
    max_memory      = '64.GB'
    max_cpus        = 8
    max_time        = '24.h'
}

// Process resource labels
process {
    // Default resources
    cpus   = { check_max( 1    * task.attempt, 'cpus'   ) }
    memory = { check_max( 4.GB * task.attempt, 'memory' ) }
    time   = { check_max( 4.h  * task.attempt, 'time'   ) }
    
    // Error handling
    errorStrategy = { task.exitStatus in [143,137,104,134,139,140] ? 'retry' : 'finish' }
    maxRetries    = 2
    maxErrors     = '-1'
    
    // Resource labels
    withLabel: process_low {
        cpus   = { check_max( 2     * task.attempt, 'cpus'   ) }
        memory = { check_max( 4.GB  * task.attempt, 'memory' ) }
        time   = { check_max( 2.h   * task.attempt, 'time'   ) }
    }
    
    withLabel: process_medium {
        cpus   = { check_max( 4     * task.attempt, 'cpus'   ) }
        memory = { check_max( 16.GB * task.attempt, 'memory' ) }
        time   = { check_max( 8.h   * task.attempt, 'time'   ) }
    }
    
    withLabel: process_high {
        cpus   = { check_max( 8     * task.attempt, 'cpus'   ) }
        memory = { check_max( 32.GB * task.attempt, 'memory' ) }
        time   = { check_max( 16.h  * task.attempt, 'time'   ) }
    }
    
    withLabel: process_high_memory {
        cpus   = { check_max( 4     * task.attempt, 'cpus'   ) }
        memory = { check_max( 64.GB * task.attempt, 'memory' ) }
        time   = { check_max( 24.h  * task.attempt, 'time'   ) }
    }
}

// Execution profiles
profiles {
    standard {
        process.executor = 'local'
    }
    
    conda {
        conda.enabled          = true
        docker.enabled         = false
        singularity.enabled    = false
        process.conda          = "${projectDir}/environment.yml"
    }
    
    docker {
        docker.enabled         = true
        docker.userEmulation   = true
        singularity.enabled    = false
        conda.enabled          = false
    }
    
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false
        conda.enabled          = false
    }
    
    // UCLA Hoffman2 cluster profile
    hoffman2 {
        process {
            executor       = 'sge'
            penv           = 'shared'
            clusterOptions = '-cwd -V'
            
            withLabel: process_low {
                queue   = 'std.q'
                memory  = '4G'
                time    = '2:00:00'
            }
            
            withLabel: process_medium {
                queue   = 'std.q'
                memory  = '16G'
                time    = '8:00:00'
            }
            
            withLabel: process_high {
                queue   = 'std.q'
                memory  = '32G'
                time    = '16:00:00'
            }
        }
        conda.enabled = true
        process.conda = "${projectDir}/environment.yml"
        
        // Hoffman2-specific paths
        params.metaphlan_db = '/u/home/c/choi/project-wonglab/RefGenomes/mpa/'
    }
    
    // SLURM cluster profile
    slurm {
        process {
            executor = 'slurm'
            queue    = 'normal'
            
            withLabel: process_low {
                cpus   = 2
                memory = '4.GB'
                time   = '2.h'
            }
            
            withLabel: process_medium {
                cpus   = 4
                memory = '16.GB'
                time   = '8.h'
            }
            
            withLabel: process_high {
                cpus   = 8
                memory = '32.GB'
                time   = '16.h'
            }
        }
    }
    
    test {
        params {
            max_cpus   = 2
            max_memory = '6.GB'
            max_time   = '1.h'
        }
    }
}

// Capture exit codes from upstream processes
process.shell = ['/bin/bash', '-euo', 'pipefail']

// Timeline, report, and trace
def timestamp = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')
timeline {
    enabled = true
    file    = "${params.tracedir}/timeline_${timestamp}.html"
}
report {
    enabled = true
    file    = "${params.tracedir}/report_${timestamp}.html"
}
trace {
    enabled = true
    file    = "${params.tracedir}/trace_${timestamp}.txt"
}
dag {
    enabled = true
    file    = "${params.tracedir}/dag_${timestamp}.svg"
}

// Function to check resource limits
def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "WARNING: Max memory '${params.max_memory}' is not valid! Using default."
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "WARNING: Max time '${params.max_time}' is not valid! Using default."
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "WARNING: Max cpus '${params.max_cpus}' is not valid! Using default."
            return obj
        }
    }
}

// Manifest
manifest {
    name            = 'saliva-cfdna-pipeline'
    author          = 'UCLA Wong Laboratory'
    homePage        = 'https://github.com/wong-lab/saliva-cfdna'
    description     = 'Saliva & Plasma cfDNA Analysis Pipeline'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04.0'
    version         = '1.0.0'
}
